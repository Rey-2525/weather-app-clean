<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rein-weather | 現在地・国内天気 & 自然言語フィルタ</title>

  <!-- Base styles -->
  <link rel="stylesheet" href="/static/style-dark.css" />

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png?v=2">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png?v=2">
  <link rel="manifest" href="/static/site.webmanifest">
  <link rel="icon" type="image/x-icon" href="/static/favicon.v3.ico">
</head>

<body>
  <!-- Header / Search -->
  <header class="fixed-top" role="banner" aria-label="検索と操作バー">
    <div class="navbar">
      <div class="brand">
        <span class="brand-emoji" aria-hidden="true"><image src="/static/weather.png" width="48" height="48"></image></span>
        <span class="brand-text">Rein-weather</span>
      </div>
      <nav class="nav-actions" aria-label="ヘルプ">
        <button id="help-toggle" class="btn ghost" aria-expanded="false" aria-controls="help-panel">使い方</button>
      </nav>
    </div>

    <div class="search-wrapper" role="search">
      <div class="search-row">
        <label class="visually-hidden" for="location-input">都市名検索</label>
        <input type="text" id="location-input" inputmode="search" placeholder="都市名（例：大阪, 札幌, 那覇）" autocomplete="off" />
        <button id="search-weather-btn" class="btn primary">国内の天気を検索</button>
      </div>
      <div class="search-row">
        <label class="visually-hidden" for="filter-input">自然言語フィルター</label>
        <input type="text" id="filter-input" inputmode="search" placeholder="例：涼しい場所を教えて / 湿度ひくめ / 条件なし" autocomplete="off" />
        <button id="filter-btn" class="btn secondary">都市をフィルタ</button>
      </div>
      <div class="search-row compact">
        <button id="get-weather-btn" type="button" class="btn accent">📍 現在地の天気を取得</button>
      </div>
    </div>

    <!-- Collapsible Help -->
    <section id="help-panel" class="help collapsed" aria-hidden="true">
      <div class="help-inner">
        <h2>使い方</h2>
        <ol>
          <li>「都市名検索」に <strong>大阪</strong> や <strong>札幌</strong> などを入力して <kbd>Enter</kbd> または <em>検索</em> を押す。</li>
          <li>「自然言語フィルター」に <strong>涼しい場所</strong>、<strong>湿度ひくめ</strong> などを入力して <em>フィルタ</em>。</li>
          <li>📍 ボタンで <strong>現在地</strong> の天気と降水確率（3時間ごと）を表示。</li>
        </ol>
        <p class="examples">
          例）<code>ひんやり</code> / <code>過ごしやすい</code> / <code>暑すぎる</code> / <code>条件なし</code>
        </p>
        <p class="note">注意：位置情報の取得はブラウザの設定で許可してください。</p>
        <p class="note">生成される解説・アドバイスはAIによるもので、必ずしも正確ではありません。</p>
      </div>
    </section>
  </header>

  <!-- Main Content -->
  <main class="container" role="main">
    <h1 aria-live="polite">天気情報が以下に表示されます</h1>

    <!-- Status / Toast -->
    <div id="status" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>

    <!-- Cards -->
    <section id="explanation-box" class="weather-card" hidden></section>
    <section id="clothing-box" class="weather-card" hidden></section>

    <!-- Current / Single city -->
    <section id="weather-current" class="weather-card" hidden></section>

    <!-- Filtered city grid -->
    <section id="weather-grid" class="weather-grid" hidden aria-label="都市カード一覧"></section>

    <!-- Loading -->
    <div id="loading" class="loading-overlay" hidden>
      <div class="loading-spinner">
        <div class="spinner" aria-hidden="true"></div>
        <p>天気情報を取得中...</p>
  </div>
</div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ---------- Utilities ----------
    // 追加：ボタン操作でのみロード表示するためのフラグ
    let shouldShowLoading = false;
    const $ = (sel) => document.querySelector(sel);
    const show = (el, flag) => { if(el) el.hidden = !flag; };
    const showLoading = (flag) => show($("#loading"), flag);
    const setStatus = (msg) => {
      const box = $("#status");
      if (!box) return;
      box.textContent = msg;
      box.hidden = !msg;
      if (!msg) {
        box.classList.add("show");
        setTimeout(() => box.classList.remove("show"), 2500);
      }
      };

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if (e.key === "/") { e.preventDefault(); $("#location-input")?.focus(); }
      if (e.key === "?") { e.preventDefault(); toggleHelp(); }
      if (e.key === "Enter") {
        const active = document.activeElement?.id;
        if (active === "location-input") $("#search-weather-btn").click();
        if (active === "filter-input") $("#filter-btn").click();
      }
    });

    // Help Toggle
     function toggleHelp() {
      $("#help-panel").classList.toggle("collapsed");
     }
    $("#help-toggle").addEventListener("click", toggleHelp);

    // ---------- Rendering ----------
    function renderCurrentWeather(data) {
      const el = $("#weather-current");
      show(el, true);
      const iconUrl = `https://openweathermap.org/img/wn/${data.icon}@2x.png`; // enforce https
      el.innerHTML = `
        <p><strong><image src="/static/placeholder.png" alt="現在地" width="30" height="30"> 場所：</strong> ${data.location}</p>
        <p><strong><image src="/static/temperatures.png" alt="現在地" width="30" height="30"> 気温：</strong> ${data.temperature}℃</p>
        <p><strong><image src="/static/moist.png" alt="現在地" width="30" height="30"> 湿度：</strong> ${data.humidity}%</p>
        <p><strong><image src="/static/clouds-and-sun.png" alt="現在地" width="30" height="30"> 天気：</strong> ${data.weather}</p>
        <div id="forecast" class="forecast"></div>
      `;
    }

    function renderForecast(forecast) {
      const parent = $("#forecast");
      if (!parent) return;
      parent.innerHTML = "<h3>☔ 降水確率（3時間ごと）</h3>";
      const labels = forecast.map(e => e.time.slice(11, 16));
      const pops = forecast.map(e => e.pop);

      const list = document.createElement("ul");
      forecast.forEach(e => {
        const li = document.createElement("li");
        li.textContent = `${e.time}：${e.pop}%`;
        list.appendChild(li);
      });
      parent.appendChild(list);

      const canvas = document.createElement("canvas");
      canvas.id = "precipChart";
      parent.appendChild(canvas);

      new Chart(canvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{ label: "降水確率 (%)", data: pops }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + "%" } } },
          plugins: { legend: { labels: { color: getComputedStyle(document.body).color } } }
        }
      });
    }

    function renderCityCard({ weatherData, explanation, advice, reason }) {
      const grid = $("#weather-grid");
      grid.insertAdjacentHTML("beforeend", `
        <article class="weather-card">
          <p><strong>📍 ${weatherData.location}</strong></p>
          <p>☁️ 天気：${weatherData.weather}、${weatherData.temperature}℃、湿度${weatherData.humidity}%</p>
          ${reason ? `<p>✨ おすすめ理由：${reason}</p>` : ""}
          <p>📝 解説：${explanation}</p>
          <p>👕 服装アドバイス：${advice}</p>
        </article>
      `);
      show(grid, true);
    }

    // ---------- API calls ----------
    async function getJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchAll(lat, lon) {
      try {
        if (shouldShowLoading) showLoading(true);
        // Current weather
        const weatherData = await getJSON(`/weather?lat=${lat}&lon=${lon}`);
        renderCurrentWeather(weatherData);

        // Forecast
        const forecastData = await getJSON(`/weather-forecast?lat=${lat}&lon=${lon}`);
        renderForecast(forecastData.forecast);

        // Explanation (use first POP)
        const pop = forecastData.forecast[0]?.pop || 0;
        const exp = await getJSON("/explanation", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            location: weatherData.location,
            weather: weatherData.weather,
            temp: weatherData.temperature,
            humidity: weatherData.humidity,
            pop: pop / 100
          })
        });
        const box1 = $("#explanation-box");
        box1.innerHTML = `<p><strong>📝 解説：</strong> ${exp.explanation}</p>`;
        show(box1, true);

        // Clothing advice
        const adv = await getJSON("/clothing_advice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            weather: weatherData.weather,
            temp: weatherData.temperature,
            humidity: weatherData.humidity
          })
        });
        const box2 = $("#clothing-box");
        box2.innerHTML = `<p><strong>🧥 服装アドバイス：</strong> ${adv.advice}</p>`;
        show(box2, true);

        setStatus("現在地の天気を更新しました");
      } catch (err) {
        $("#weather-current").innerHTML = "取得に失敗しました。";
        show($("#weather-current"), true);
        console.error(err);
        setStatus("取得に失敗しました");
      } finally {
        if (shouldShowLoading) showLoading(false);
        shouldShowLoading = false; // Reset flag
      }
    }

    // Keep last city list to avoid redundant renders
    let previousCityList = [];

    function listsEqual(a, b) {
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) {
        const pa = typeof a[i] === "object" ? a[i].name : a[i];
        const pb = typeof b[i] === "object" ? b[i].name : b[i];
        if (pa !== pb) return false;
      }
      return true;
    }

    async function fetchFilteredCities(keyword) {
      let timer = null;
      if (shouldShowLoading){
        timer = setTimeout(() => showLoading(true), 250); // Show loading if takes >500ms
      }
      try {
        // Hide current boxes when switching to grid
        show($("#explanation-box"), false);
        show($("#clothing-box"), false);
        show($("#weather-current"), false);

        const fuzzyWords = ["ジメジメ","ひんやり","過ごしやすい","暑すぎる","寒い","涼しい","湿度","温度","条件なし"];
        const isFuzzy = fuzzyWords.some(w => keyword.includes(w)) || keyword.length >= 10;
        const endpoint = isFuzzy ? "/filter-nlp" : "/filter";
        const body = isFuzzy ? { message: keyword } : { keyword };

        const filterData = await getJSON(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const cityList = filterData.cities || [];
        if (cityList.length === 0 || (cityList[0]?.message?.includes("見つかりませんでした"))) {
          $("#weather-grid").innerHTML = `<article class="weather-card"><p>😢 条件に合う都市が見つかりませんでした。</p></article>`;
          show($("#weather-grid"), true);
          previousCityList = [];
          return;
        }

        if (listsEqual(previousCityList, cityList)) {
          setStatus("同じ結果のため更新をスキップ");
          return;
        }
        previousCityList = cityList;

        const grid = $("#weather-grid");
        grid.innerHTML = "";
        show(grid, true);

        for (const city of cityList) {
          // 1) geocode
          const geo = await getJSON("/geocode", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ city: city.name })
          });
          if (!geo.lat || !geo.lon) continue;

          // 2) weather
          const weatherData = await getJSON(`/weather?lat=${geo.lat}&lon=${geo.lon}`);

          // 3) explanation
          const explanation = await getJSON("/explanation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              location: weatherData.location,
              weather: weatherData.weather,
              temp: weatherData.temperature,
              humidity: weatherData.humidity,
              pop: 0.2
            })
          });

          // 4) clothing advice
          const advice = await getJSON("/clothing_advice", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              weather: weatherData.weather,
              temp: weatherData.temperature,
              humidity: weatherData.humidity
            })
          });

          // 5) render
          renderCityCard({
            weatherData,
            explanation: explanation.explanation,
            advice: advice.advice,
            reason: city.reason
          });
        }
        setStatus("フィルタ結果を更新しました");
      } catch (err) {
        console.error("フィルタ検索中にエラー:", err);
        setStatus("フィルタ取得中にエラーが発生しました");
        $("#weather-grid").innerHTML = `<article class="weather-card"><p>エラーが発生しました。</p></article>`;
        show($("#weather-grid"), true);
      } finally {
        if (timer) clearTimeout(timer);
        if (shouldShowLoading) showLoading(false);
        shouldShowLoading = false; // Reset flag
      }
    }

    // ---------- Event bindings ----------
    $("#get-weather-btn").addEventListener("click", (e) => {
      e.preventDefault();
      shouldShowLoading = true; // Set flag to show loading
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => fetchAll(pos.coords.latitude, pos.coords.longitude),
          (error) => {
            $("#weather-current").textContent = "位置情報が取得できませんでした。";
            show($("#weather-current"), true);
            console.error("位置情報の取得に失敗:", error);
            shouldShowLoading = false; // 失敗時に消す
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        $("#weather-current").textContent = "このブラウザは位置情報に対応していません。";
        show($("#weather-current"), true);
      }
    });

    $("#filter-btn").addEventListener("click", async () => {
      const keyword = $("#filter-input").value.trim();
      if (!keyword) { setStatus("キーワードを入力してください"); return; }
      shouldShowLoading = true;
      await fetchFilteredCities(keyword);
    });

    $("#search-weather-btn").addEventListener("click", async () => {
      const city = $("#location-input").value.trim();
      if (!city) { setStatus("都市名を入力してください"); return; }
      shouldShowLoading = true;
      try {
        const data = await getJSON("/geocode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ city })
        });
        if (data.lat && data.lon) {
          await fetchAll(data.lat, data.lon);
          setStatus(`${city} の天気を表示しました`);
        } else {
          setStatus("場所が見つかりませんでした");
        }
      } catch (err) {
        console.error("地名検索に失敗しました:", err);
        setStatus("地名検索でエラーが発生しました");
      } finally {
        showLoading(false);
      }
    });
  </script>
  <script
     src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&v=weekly" async defer>
  </script>
</body>
</html>
