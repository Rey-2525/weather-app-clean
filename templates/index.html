<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rein-weather | ç¾åœ¨åœ°ãƒ»å›½å†…å¤©æ°— & è‡ªç„¶è¨€èªãƒ•ã‚£ãƒ«ã‚¿</title>

  <!-- Base styles -->
  <link rel="stylesheet" href="/static/style-dark.css" />

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png?v=2">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png?v=2">
  <link rel="manifest" href="/static/site.webmanifest">
  <link rel="icon" type="image/x-icon" href="/static/favicon.v3.ico">
</head>

<body>
  <!-- Header / Search -->
  <header class="fixed-top" role="banner" aria-label="æ¤œç´¢ã¨æ“ä½œãƒãƒ¼">
    <div class="navbar">
      <div class="brand">
        <span class="brand-emoji" aria-hidden="true"><image src="/static/weather.png" width="48" height="48"></image></span>
        <span class="brand-text">Rein-weather</span>
      </div>
      <nav class="nav-actions" aria-label="ãƒ˜ãƒ«ãƒ—">
        <button id="help-toggle" class="btn ghost" aria-expanded="false" aria-controls="help-panel">ä½¿ã„æ–¹</button>
      </nav>
    </div>

    <div class="search-wrapper" role="search">
      <div class="search-row">
        <label class="visually-hidden" for="location-input">éƒ½å¸‚åæ¤œç´¢</label>
        <input type="text" id="location-input" inputmode="search" placeholder="éƒ½å¸‚åï¼ˆä¾‹ï¼šå¤§é˜ª, æœ­å¹Œ, é‚£è¦‡ï¼‰" autocomplete="off" />
        <button id="search-weather-btn" class="btn primary">å›½å†…ã®å¤©æ°—ã‚’æ¤œç´¢</button>
      </div>
      <div class="search-row">
        <label class="visually-hidden" for="filter-input">è‡ªç„¶è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <input type="text" id="filter-input" inputmode="search" placeholder="ä¾‹ï¼šæ¶¼ã—ã„å ´æ‰€ã‚’æ•™ãˆã¦ / æ¹¿åº¦ã²ãã‚ / æ¡ä»¶ãªã—" autocomplete="off" />
        <button id="filter-btn" class="btn secondary">éƒ½å¸‚ã‚’ãƒ•ã‚£ãƒ«ã‚¿</button>
      </div>
      <div class="search-row compact">
        <button id="get-weather-btn" type="button" class="btn accent">ğŸ“ ç¾åœ¨åœ°ã®å¤©æ°—ã‚’å–å¾—</button>
      </div>
    </div>

    <!-- Collapsible Help -->
    <section id="help-panel" class="help collapsed" aria-hidden="true">
      <div class="help-inner">
        <h2>ä½¿ã„æ–¹</h2>
        <ol>
          <li>ã€Œéƒ½å¸‚åæ¤œç´¢ã€ã« <strong>å¤§é˜ª</strong> ã‚„ <strong>æœ­å¹Œ</strong> ãªã©ã‚’å…¥åŠ›ã—ã¦ <kbd>Enter</kbd> ã¾ãŸã¯ <em>æ¤œç´¢</em> ã‚’æŠ¼ã™ã€‚</li>
          <li>ã€Œè‡ªç„¶è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã« <strong>æ¶¼ã—ã„å ´æ‰€</strong>ã€<strong>æ¹¿åº¦ã²ãã‚</strong> ãªã©ã‚’å…¥åŠ›ã—ã¦ <em>ãƒ•ã‚£ãƒ«ã‚¿</em>ã€‚</li>
          <li>ğŸ“ ãƒœã‚¿ãƒ³ã§ <strong>ç¾åœ¨åœ°</strong> ã®å¤©æ°—ã¨é™æ°´ç¢ºç‡ï¼ˆ3æ™‚é–“ã”ã¨ï¼‰ã‚’è¡¨ç¤ºã€‚</li>
        </ol>
        <p class="examples">
          ä¾‹ï¼‰<code>ã²ã‚“ã‚„ã‚Š</code> / <code>éã”ã—ã‚„ã™ã„</code> / <code>æš‘ã™ãã‚‹</code> / <code>æ¡ä»¶ãªã—</code>
        </p>
        <p class="note">æ³¨æ„ï¼šä½ç½®æƒ…å ±ã®å–å¾—ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
        <p class="note">ç”Ÿæˆã•ã‚Œã‚‹è§£èª¬ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯AIã«ã‚ˆã‚‹ã‚‚ã®ã§ã€å¿…ãšã—ã‚‚æ­£ç¢ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </div>
    </section>
  </header>

  <!-- Main Content -->
  <main class="container" role="main">
    <h1 aria-live="polite">å¤©æ°—æƒ…å ±ãŒä»¥ä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™</h1>

    <!-- Status / Toast -->
    <div id="status" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>

    <!-- Cards -->
    <section id="explanation-box" class="weather-card" hidden></section>
    <section id="clothing-box" class="weather-card" hidden></section>

    <!-- Current / Single city -->
    <section id="weather-current" class="weather-card" hidden></section>

    <!-- Filtered city grid -->
    <section id="weather-grid" class="weather-grid" hidden aria-label="éƒ½å¸‚ã‚«ãƒ¼ãƒ‰ä¸€è¦§"></section>

    <!-- Loading -->
    <div id="loading" class="loading-overlay" hidden>
      <div class="loading-spinner">
        <div class="spinner" aria-hidden="true"></div>
        <p>å¤©æ°—æƒ…å ±ã‚’å–å¾—ä¸­...</p>
  </div>
</div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ---------- Utilities ----------
    // è¿½åŠ ï¼šãƒœã‚¿ãƒ³æ“ä½œã§ã®ã¿ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
    let shouldShowLoading = false;
    const $ = (sel) => document.querySelector(sel);
    const show = (el, flag) => { if(el) el.hidden = !flag; };
    const showLoading = (flag) => show($("#loading"), flag);
    const setStatus = (msg) => {
      const box = $("#status");
      if (!box) return;
      box.textContent = msg;
      box.hidden = !msg;
      if (!msg) {
        box.classList.add("show");
        setTimeout(() => box.classList.remove("show"), 2500);
      }
      };

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      if (e.key === "/") { e.preventDefault(); $("#location-input")?.focus(); }
      if (e.key === "?") { e.preventDefault(); toggleHelp(); }
      if (e.key === "Enter") {
        const active = document.activeElement?.id;
        if (active === "location-input") $("#search-weather-btn").click();
        if (active === "filter-input") $("#filter-btn").click();
      }
    });

    // Help Toggle
     function toggleHelp() {
      $("#help-panel").classList.toggle("collapsed");
     }
    $("#help-toggle").addEventListener("click", toggleHelp);

    // ---------- Rendering ----------
    function renderCurrentWeather(data) {
      const el = $("#weather-current");
      show(el, true);
      const iconUrl = `https://openweathermap.org/img/wn/${data.icon}@2x.png`; // enforce https
      el.innerHTML = `
        <p><strong><image src="/static/placeholder.png" alt="ç¾åœ¨åœ°" width="30" height="30"> å ´æ‰€ï¼š</strong> ${data.location}</p>
        <p><strong><image src="/static/temperatures.png" alt="ç¾åœ¨åœ°" width="30" height="30"> æ°—æ¸©ï¼š</strong> ${data.temperature}â„ƒ</p>
        <p><strong><image src="/static/moist.png" alt="ç¾åœ¨åœ°" width="30" height="30"> æ¹¿åº¦ï¼š</strong> ${data.humidity}%</p>
        <p><strong><image src="/static/clouds-and-sun.png" alt="ç¾åœ¨åœ°" width="30" height="30"> å¤©æ°—ï¼š</strong> ${data.weather}</p>
        <div id="forecast" class="forecast"></div>
      `;
    }

    function renderForecast(forecast) {
      const parent = $("#forecast");
      if (!parent) return;
      parent.innerHTML = "<h3>â˜” é™æ°´ç¢ºç‡ï¼ˆ3æ™‚é–“ã”ã¨ï¼‰</h3>";
      const labels = forecast.map(e => e.time.slice(11, 16));
      const pops = forecast.map(e => e.pop);

      const list = document.createElement("ul");
      forecast.forEach(e => {
        const li = document.createElement("li");
        li.textContent = `${e.time}ï¼š${e.pop}%`;
        list.appendChild(li);
      });
      parent.appendChild(list);

      const canvas = document.createElement("canvas");
      canvas.id = "precipChart";
      parent.appendChild(canvas);

      new Chart(canvas, {
        type: "bar",
        data: {
          labels,
          datasets: [{ label: "é™æ°´ç¢ºç‡ (%)", data: pops }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + "%" } } },
          plugins: { legend: { labels: { color: getComputedStyle(document.body).color } } }
        }
      });
    }

    function renderCityCard({ weatherData, explanation, advice, reason }) {
      const grid = $("#weather-grid");
      grid.insertAdjacentHTML("beforeend", `
        <article class="weather-card">
          <p><strong>ğŸ“ ${weatherData.location}</strong></p>
          <p>â˜ï¸ å¤©æ°—ï¼š${weatherData.weather}ã€${weatherData.temperature}â„ƒã€æ¹¿åº¦${weatherData.humidity}%</p>
          ${reason ? `<p>âœ¨ ãŠã™ã™ã‚ç†ç”±ï¼š${reason}</p>` : ""}
          <p>ğŸ“ è§£èª¬ï¼š${explanation}</p>
          <p>ğŸ‘• æœè£…ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š${advice}</p>
        </article>
      `);
      show(grid, true);
    }

    // ---------- API calls ----------
    async function getJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchAll(lat, lon) {
      try {
        if (shouldShowLoading) showLoading(true);
        // Current weather
        const weatherData = await getJSON(`/weather?lat=${lat}&lon=${lon}`);
        renderCurrentWeather(weatherData);

        // Forecast
        const forecastData = await getJSON(`/weather-forecast?lat=${lat}&lon=${lon}`);
        renderForecast(forecastData.forecast);

        // Explanation (use first POP)
        const pop = forecastData.forecast[0]?.pop || 0;
        const exp = await getJSON("/explanation", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            location: weatherData.location,
            weather: weatherData.weather,
            temp: weatherData.temperature,
            humidity: weatherData.humidity,
            pop: pop / 100
          })
        });
        const box1 = $("#explanation-box");
        box1.innerHTML = `<p><strong>ğŸ“ è§£èª¬ï¼š</strong> ${exp.explanation}</p>`;
        show(box1, true);

        // Clothing advice
        const adv = await getJSON("/clothing_advice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            weather: weatherData.weather,
            temp: weatherData.temperature,
            humidity: weatherData.humidity
          })
        });
        const box2 = $("#clothing-box");
        box2.innerHTML = `<p><strong>ğŸ§¥ æœè£…ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š</strong> ${adv.advice}</p>`;
        show(box2, true);

        setStatus("ç¾åœ¨åœ°ã®å¤©æ°—ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      } catch (err) {
        $("#weather-current").innerHTML = "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        show($("#weather-current"), true);
        console.error(err);
        setStatus("å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      } finally {
        if (shouldShowLoading) showLoading(false);
        shouldShowLoading = false; // Reset flag
      }
    }

    // Keep last city list to avoid redundant renders
    let previousCityList = [];

    function listsEqual(a, b) {
      if (a.length !== b.length) return false;
      for (let i = 0; i < a.length; i++) {
        const pa = typeof a[i] === "object" ? a[i].name : a[i];
        const pb = typeof b[i] === "object" ? b[i].name : b[i];
        if (pa !== pb) return false;
      }
      return true;
    }

    async function fetchFilteredCities(keyword) {
      let timer = null;
      if (shouldShowLoading){
        timer = setTimeout(() => showLoading(true), 250); // Show loading if takes >500ms
      }
      try {
        // Hide current boxes when switching to grid
        show($("#explanation-box"), false);
        show($("#clothing-box"), false);
        show($("#weather-current"), false);

        const fuzzyWords = ["ã‚¸ãƒ¡ã‚¸ãƒ¡","ã²ã‚“ã‚„ã‚Š","éã”ã—ã‚„ã™ã„","æš‘ã™ãã‚‹","å¯’ã„","æ¶¼ã—ã„","æ¹¿åº¦","æ¸©åº¦","æ¡ä»¶ãªã—"];
        const isFuzzy = fuzzyWords.some(w => keyword.includes(w)) || keyword.length >= 10;
        const endpoint = isFuzzy ? "/filter-nlp" : "/filter";
        const body = isFuzzy ? { message: keyword } : { keyword };

        const filterData = await getJSON(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const cityList = filterData.cities || [];
        if (cityList.length === 0 || (cityList[0]?.message?.includes("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"))) {
          $("#weather-grid").innerHTML = `<article class="weather-card"><p>ğŸ˜¢ æ¡ä»¶ã«åˆã†éƒ½å¸‚ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p></article>`;
          show($("#weather-grid"), true);
          previousCityList = [];
          return;
        }

        if (listsEqual(previousCityList, cityList)) {
          setStatus("åŒã˜çµæœã®ãŸã‚æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—");
          return;
        }
        previousCityList = cityList;

        const grid = $("#weather-grid");
        grid.innerHTML = "";
        show(grid, true);

        for (const city of cityList) {
          // 1) geocode
          const geo = await getJSON("/geocode", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ city: city.name })
          });
          if (!geo.lat || !geo.lon) continue;

          // 2) weather
          const weatherData = await getJSON(`/weather?lat=${geo.lat}&lon=${geo.lon}`);

          // 3) explanation
          const explanation = await getJSON("/explanation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              location: weatherData.location,
              weather: weatherData.weather,
              temp: weatherData.temperature,
              humidity: weatherData.humidity,
              pop: 0.2
            })
          });

          // 4) clothing advice
          const advice = await getJSON("/clothing_advice", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              weather: weatherData.weather,
              temp: weatherData.temperature,
              humidity: weatherData.humidity
            })
          });

          // 5) render
          renderCityCard({
            weatherData,
            explanation: explanation.explanation,
            advice: advice.advice,
            reason: city.reason
          });
        }
        setStatus("ãƒ•ã‚£ãƒ«ã‚¿çµæœã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      } catch (err) {
        console.error("ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
        setStatus("ãƒ•ã‚£ãƒ«ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        $("#weather-grid").innerHTML = `<article class="weather-card"><p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p></article>`;
        show($("#weather-grid"), true);
      } finally {
        if (timer) clearTimeout(timer);
        if (shouldShowLoading) showLoading(false);
        shouldShowLoading = false; // Reset flag
      }
    }

    // ---------- Event bindings ----------
    $("#get-weather-btn").addEventListener("click", (e) => {
      e.preventDefault();
      shouldShowLoading = true; // Set flag to show loading
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => fetchAll(pos.coords.latitude, pos.coords.longitude),
          (error) => {
            $("#weather-current").textContent = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            show($("#weather-current"), true);
            console.error("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—:", error);
            shouldShowLoading = false; // å¤±æ•—æ™‚ã«æ¶ˆã™
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        $("#weather-current").textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚";
        show($("#weather-current"), true);
      }
    });

    $("#filter-btn").addEventListener("click", async () => {
      const keyword = $("#filter-input").value.trim();
      if (!keyword) { setStatus("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      shouldShowLoading = true;
      await fetchFilteredCities(keyword);
    });

    $("#search-weather-btn").addEventListener("click", async () => {
      const city = $("#location-input").value.trim();
      if (!city) { setStatus("éƒ½å¸‚åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      shouldShowLoading = true;
      try {
        const data = await getJSON("/geocode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ city })
        });
        if (data.lat && data.lon) {
          await fetchAll(data.lat, data.lon);
          setStatus(`${city} ã®å¤©æ°—ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        } else {
          setStatus("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        }
      } catch (err) {
        console.error("åœ°åæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
        setStatus("åœ°åæ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      } finally {
        showLoading(false);
      }
    });
  </script>
  <script
     src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&v=weekly" async defer>
  </script>
</body>
</html>
